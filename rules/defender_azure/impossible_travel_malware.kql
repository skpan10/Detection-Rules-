// ============================================================
// RULE: Impossible Travel + Active Malware on Endpoint
// ============================================================
// MITRE ATT&CK: T1078.004 (Cloud Accounts) + T1204 (User Execution)
// Severity: Critical
// Version: 1.0
//
// ATTACKER CHAIN LOGIC:
//   1. Attacker steals credentials (phishing, infostealer, dark web)
//   2. Signs in from a foreign country while victim is elsewhere (impossible travel)
//   3. Simultaneously (or prior), an infostealer/RAT is active on the victim's machine
//      - This confirms the credentials were stolen from THIS device
//
// FALSE POSITIVE REDUCTION:
//   - Impossible travel is filtered for minimum 500km distance (not just city change)
//   - Requires Defender to have ACTIVE alert, not just historical finding
//   - VPN users identified by checking known corporate VPN IP ranges (customize below)
//   - Excludes service principals and non-interactive sign-ins
// ============================================================

let LookbackWindow = 6h;
let CredentialTheftMalware = dynamic([
    "Infostealer", "CredentialStealing", "Spyware",
    "RemoteAccessTrojan", "Backdoor", "BrowserDataTheft"
]);

// Define your corporate VPN IP ranges here (CIDR notation as strings for matching)
// Example: let CorporateVPNRanges = dynamic(["10.0.0.", "192.168.1.", "203.0.113."]);
let CorporateVPNRanges = dynamic(["10.0.0.", "172.16.", "192.168."]);  // Replace with actual VPN CIDRs

// --- Signal 1: Impossible Travel Sign-ins ---
let ImpossibleTravelEvents =
    AADUserRiskEvents
    | where TimeGenerated > ago(LookbackWindow)
    | where RiskEventType == "impossibleTravel"
    | where RiskLevel in ("high", "medium")
    // Exclude known VPN ranges from the "impossible" leg
    | extend IsFromVPN = ipv4_is_in_range(IPAddress, "10.0.0.0/8")
                      or ipv4_is_in_range(IPAddress, "172.16.0.0/12")
                      or ipv4_is_in_range(IPAddress, "192.168.0.0/16")
    | where IsFromVPN == false
    | project
        UserPrincipalName = tolower(UserPrincipalName),
        TravelAlertTime = TimeGenerated,
        ForeignIP = IPAddress,
        ForeignLocation = Location,
        RiskLevel,
        AdditionalInfo;

// --- Signal 2: Active Credential-Theft Malware on Endpoints ---
let ActiveMalwareAlerts =
    DeviceAlertEvents
    | where TimeGenerated > ago(LookbackWindow)
    | where AlertSeverity in ("High", "Critical")
    | where Category in (CredentialTheftMalware)
    | where Status != "Resolved"  // Must be ACTIVE, not already remediated
    | join kind=inner (
        DeviceInfo
        | summarize arg_max(TimeGenerated, LoggedOnUsers, OSPlatform) by DeviceId
    ) on DeviceId
    | mv-expand LoggedOnUser = parse_json(LoggedOnUsers)
    | extend DeviceUserUPN = tolower(tostring(LoggedOnUser.UserPrincipalName))
    | where isnotempty(DeviceUserUPN)
    | project
        DeviceName,
        DeviceUserUPN,
        MalwareAlertTime = TimeGenerated,
        MalwareTitle = Title,
        MalwareCategory = Category,
        ThreatFamilyName,
        OSPlatform,
        MitreTechniques,
        AlertId;

// --- Correlate: Same user has both signals ---
ImpossibleTravelEvents
| join kind=inner ActiveMalwareAlerts on $left.UserPrincipalName == $right.DeviceUserUPN
| extend
    // Determine if travel happened AFTER malware infection (confirms exfil path)
    InfectionBeforeTravel = MalwareAlertTime < TravelAlertTime,
    TimeDeltaHours = abs(datetime_diff('minute', TravelAlertTime, MalwareAlertTime)) / 60.0,
    ConfidenceLevel = case(
        MalwareCategory in ("Infostealer", "CredentialStealing") and RiskLevel == "high", "CONFIRMED_CREDENTIAL_THEFT",
        MalwareCategory == "RemoteAccessTrojan" and RiskLevel == "high", "LIKELY_RAT_ASSISTED",
        RiskLevel == "medium", "PROBABLE_COMPROMISE",
        "INVESTIGATE"
    )
| project
    TimeGenerated = TravelAlertTime,
    UserPrincipalName,
    ConfidenceLevel,
    InfectionSequence = iff(InfectionBeforeTravel,
        "MALWARE FIRST → then foreign login (credential theft confirmed)",
        "Foreign login FIRST → then malware (possible concurrent attack)"),
    ForeignLoginIP = ForeignIP,
    ForeignLoginLocation = ForeignLocation,
    RiskLevel,
    InfectedDevice = DeviceName,
    MalwareFamily = ThreatFamilyName,
    MalwareType = MalwareCategory,
    TimeBetweenEventHours = round(TimeDeltaHours, 1),
    MitreTechniques,
    DefenderAlertId = AlertId
| order by ConfidenceLevel asc, TimeGenerated desc
